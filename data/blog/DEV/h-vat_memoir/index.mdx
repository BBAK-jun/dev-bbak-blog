---
title: h-vat 리뉴얼 프로젝트를 진행하면서
date: '2023-12-18T18:53:03.284Z'
summary: 레거시에 대하는 나의 자세를 바꾸게 된 계기
tags: ['DEV']
---

휴톰에 2023년 6월 1일에 합류하여 6개월이 지났다.
입사 후 대략 한달간의 교육기간을 거쳐 7월부터 실제 업무를 시작하였다.
입사 후 6개월간의 나의 성장과 느낀점을 정리해보고자 한다.

## 입사부터 현재까지

휴톰에 합류하기 전의 나의 생각은 다음과 같았다.

- 레거시는 나쁘다.
- 레거시는 잘못된 설계로 인해 발생한다.
- 레거시는 개발자의 능력이 부족(??)해서 발생한다.

이러한 생각으로 레거시를 피하고 싶었다.

당시의 개발자들의 능력이 정말 부족해서 였을까? 이 질문에 대한 답은 무조건 `NO`이다.
그렇다면 왜 레거시가 발생했을까?

이 질문에 대한 답은 레거시는 시간이 지나면서 발생한다. 그 당시의 상황에서는 그것이 최선이었을 것이다. 하지만 현재에는 최선일 수도 아닐 수도 있다.

**h-vat**도 **annotation-tool**이라는 프로젝트에서 리뉴얼되었다.

**annotation-tool**은 2018년부터 개발되었고 클라이언트들의 피드백을 받아 성장해왔고 현재 휴톰의 생산성을 증대시켜주고있는 효자 애플리케이션이다.

휴톰 링크드인에 공개되어있는 [annotation-tool의 소개글](https://zrr.kr/rDol)은 다음과 같다.
근영님이 annotation-tool을 사용하시면서 데이터 매니저로서 비지니스적으로 어떤 기열르 하셨는지 그리고 어떤 효과를 봤는지에 대한 내용이 담겨있다. (좋은 소스를 제공해주신 근영님 감사합니다..!)

<img src="https://media.licdn.com/dms/image/D4E12AQENSFbXRbbwjA/article-inline_image-shrink_1000_1488/0/1679467122004?e=1708560000&v=beta&t=PEvqMdCRTc5olIlpWqLarv65GZ3mWJOGZMT2_E7NwGA" />

annotation-tool을 너무나 잘 사용해주시는 타 부서분들이 계시지만, 그만큼 많은 요구사항들이 들어왔다. 그리고 현재에서는 불가능한 요구사항도 존재해서 리뉴얼을 해보자는 결론이 나왔다.

## 어떤것을 개선해야하는가?

리뉴얼 진행하기 앞서 어떤것이 문제인가를 점검해보았다.

- 데이터 관련된 비지니스 로직이 프론트엔드에 집중되어 있었다.
- 데이터 모델링에 대한 확장성이 고려되지 않았었다.
- 배포 자동화등 개발환경에서 부족한 점이 존재하였다.
- 서비스를 운영함에 따라 고정 지출 비용이 꽤(?) 많이 발생하였다.

이 문제점들은 개인적인 생각이다. 왜냐하면 그 당시에는 그것이 최선이었기 때문이다.
당시에는 프로토타입을 빠르게 개발하여 클라이언트들의 피드백을 받아야 했기 때문이고, 현재는 기존의 문제점들을 개선해야하는것이 나의 책임이기 때문이다.

### 데이터 관련된 비지니스 로직이 프론트엔드에 집중되어 있었다.

데이터 관련된 비지니스 로직이 프론트엔드에 집중되어 있었다.
비디오 영상 데이터에대한 정답지를 생성하고 병합하는 작업이 프론트엔드에 존재하였고, 데이터를 적재하는 작업이 백엔드에서보다 프론트엔드에 비중이 컸다.

무슨말인지 잘 이해가 안될 수 있으니 간단히 예시를 들자면 TodoList를 생성하고 수정하는데 수정할때 특정 Todo에대한 수정이 아닌 프론트엔드에서 수정을 완료한 후 전체 TodoList를 백엔드에 전송하는 방식이었다.

이로 인해 프론트엔드에서 데이터를 관리하는 비지니스 로직이 많아졌고, 데이터를 관리하는 비지니스 로직이 많아질수록 유지보수가 어려워졌다.

### 데이터 모델링에 대한 확장성이 고려되지 않았었다.

데이터는 많아지고 데이터의 타입도 많아지는데 이러한 데이터를 관리하기 위한 데이터 모델링이 고려되지 않았었다. 어노테이터들이 진행하는 작업의 타입과 정답지들의 타입도 많아지고, 학습을 통해 모델이 달라져야하는 상황에서 프론트엔드와 백엔드에 하드코딩 되어있는 기존의 설계에서는 거의 불가능한 상황이었다.

그렇기에 관리자 페이지를 통해 데이터 모델링을 확장 할 수 있도록 설계해야한다고 생각을 하게되었고 유관부서 사람들과 회의를 통해 데이터 모델링을 확장할 수 있도록 설계하게 되었다.

### 배포 자동화등 개발환경에서 부족한 점이 존재하였다.

배포 자동화등 개발환경에서 부족한 점이 존재하였다.

CI/CD에서 도커 이미지로 빌드하여 `Google Artifact Registry`에 애플리케이션 서버 이미지를 푸시하고 `Google Compute Engine`에 배포하는 과정이 수동으로 진행되었다.

현재 규모에서 **Production Level**에서는 수동으로 하는게 일반적으로 괜찮겠다 싶었다

하지만 **Staging Level**에서는 통합부터 배포까지 자동화가 되어있어야 한다고 생각하게 되었고 배포환경의 버저닝까지 함께 고려하게 되었다.

### 서비스를 운영함에 따라 고정 지출 비용이 꽤(?) 많이 발생하였다.

다시한번 말하지만 annotation-tool은 인하우스 솔루션이다. 휴톰 내부에서만 사용되는 솔루션이다. 그러므로 고객은 휴톰의 임직원들이고 더 고려할 수 있다면 단기 아르바이트로 일하는 인력들도 포함된다.

고객 즉 **어노테이터**들이 **24시간** **365일** 일을 하는가? 그리고 우리의 서버가 과연 **24시간** **365일** 동안 돌아가야할까? 라는 의문이 들었다.

이 의문에 대한 답은 **NO**이다. 그렇기에 `Google Compute Engine`과 같은 VPC환경에서 인스턴스가 24시간 265일 동안 돌아가는것은 비용측면에서 매우 비효율적이다.

## 어떻게 개선할 것인가?

### 데이터 관련된 비지니스 로직이 프론트엔드에 집중되어 있었다.

이 문제를 해결하기 위해 데이터 관련된 비지니스 로직을 백엔드로 이동시켜야한다고 생각하였다.

프론트엔드는 유저가 보는 화면을 구성하는것에 집중하고, 백엔드는 데이터를 관리하는 비지니스 로직에 집중하도록 설계하였다.

Restful API의 단위를 작게 설계하여 프론트엔드에서 필요한 데이터를 요청하고, 백엔드에서는 요청받은 데이터를 가공하여 응답하는 방식으로 설계하였다.

### 데이터 모델링에 대한 확장성이 고려되지 않았었다.

이 문제를 해결하기 위해 데이터 모델링을 관리자 페이지를 통해 확장할 수 있도록 설계하였다.

관계형 데이터가 굉장히 많았던 프로젝트였다. 각 데이터가 유기적으로 연결되어있었고 중복되는 데이터를 최소화하고 원자단위로 데이터를 관리하고 있었다.

그래서 nosql인 MongoDB를 사용하던 기존의 방식에서 관계형 데이터베이스인 PostgreSQL로 변경하였다. 그리고 새롭게 데이터베이스 재 설계를 하였다. 각 엔터티들간의 관계를 정의하고, 데이터를 관리하는 비지니스 로직을 백엔드로 이동시키면서 데이터 모델링에 대한 확장성을 고려하였다.

### 배포 자동화등 개발환경에서 부족한 점이 존재하였다.

이 문제를 해결하기위해 Cloud Function 혹은 Cloud Build등 여러가지 클라우드 서비스를 사용하여 자동화하는것을 고려하였다.

### 서비스를 운영함에 따라 고정 지출 비용이 꽤(?) 많이 발생하였다.

결론부터 말하자면 Google Cloud Platform의 서비스를 사용하여 비용을 최소화하고자 하였다. 그래서 `Google Compute Engine`에서 `Google Cloud Run`으로 변경하였다.

이유는 간단했다. 우리의 서버는 24시간 365일 동안 돌아가지 않아도 된다는것이다. 그렇기에 서버리스 아키텍처를 구상하게되었지만 콜드스타트라는 문제가 발생하였다.

콜드스타트는 서버리스 아키텍처에서 발생하는 문제로, 서버가 쉬고있는 상태에서 요청이 들어오면 서버가 깨어나는 시간이 발생하는 문제이다.

이 문제를 해결하기 위해 고려해볼 수 있던 방법은 세가지 정도가 있었다.

![](/static/images/DEV/h-vat_memoir/min_instance.png)

**Cloud Run의 `min-instances`를 사용하여 최소 인스턴스를 유지하는 방법**

![](/static/images/DEV/h-vat_memoir/polling.png)

**Cloud Scheduler를 사용하여 주기적으로 요청을 보내는 방법**

![](/static/images/DEV/h-vat_memoir/loop.png)

**인스턴스가 종료되는 시점에 알림을 주는 웹훅으로 인스턴스 재 생성으로 인스턴스 무한 생성으로 해결하는 방법**

최소 인스턴스를 두는것은 기존의 방식과 비슷한 방법이라고 생각하였고, 루프를 돌아 인스턴스를 재 실행해주는 방법도 재설계의 목적과는 맞지않다고 생각하게 되었다.

그래서 `Cloud Scheduler`를 사용하여 주기적으로 요청을 보내는 방법으로 설게하였다.

## 코드레벨에서의 개선

### 스택의 최신화

기존의 프로젝트는 `React`와 `Redux`를 사용하여 프론트엔드를 구성하였다. 그리고 `Express`와 `Mongoose`를 사용하여 백엔드를 구성하였다.

리뉴얼을 진행하면서 프론트엔드는 `React`와 `React-Query`, `Zustand`를 사용하여 구성하였고, 백엔드는 `Nest.js`와 `Typeorm`을 사용하여 구성하였다.

왜 최신화가 필요한지는 다음과 같다.

- `React`의 경우 `React-Query`와 `Zustand`를 사용하여 서버상태와 클라이언트 상태관리를 나누어 관리하였다. `Redux`를 사용하지 않은 이유는 `Redux`를 사용하면서 느꼈던 불편함이 있었고, `Redux`를 사용하지 않고도 상태관리를 할 수 있는 방법이 존재한다는것을 알게되었기 때문이다.

<hr />

## 참고자료

- https://medium.com/google-cloud/3-solutions-to-mitigate-the-cold-starts-on-cloud-run-8c60f0ae7894
